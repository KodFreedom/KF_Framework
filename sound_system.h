//--------------------------------------------------------------------------------
//　sound_system.h
//  manage the se,bgm's save, load
//  サウンド管理者
//  Author : 徐文杰(KodFreedom)
//--------------------------------------------------------------------------------
#pragma once
#include <XAudio2.h>
#include "common_setting.h"

//--------------------------------------------------------------------------------
//  列挙型定義
//--------------------------------------------------------------------------------
enum SoundEffectLabel
{
    kSubmitSoundEffect,
    kSoundEffectMax,
};

//--------------------------------------------------------------------------------
//  サウンド管理者クラス
//--------------------------------------------------------------------------------
class SoundSystem final
{
public:
    //--------------------------------------------------------------------------------
    //  生成処理
    //  return : SoundSystem*
    //--------------------------------------------------------------------------------
    static SoundSystem* Create(void)
    {
        auto instance = MY_NEW SoundSystem();
        instance->Init();
        return instance;
    }

    //--------------------------------------------------------------------------------
    //  破棄処理
    //--------------------------------------------------------------------------------
    void Release(void);

    //--------------------------------------------------------------------------------
    //  指定したサウンドを鳴らす
    //  label : sound effectのラベル
    //--------------------------------------------------------------------------------
    void Play(const SoundEffectLabel label)
    {
        se_play_tasks_.push(label);
    }

    //--------------------------------------------------------------------------------
    //  指定したサウンドを止める
    //  label : sound effectのラベル
    //--------------------------------------------------------------------------------
    void Stop(const SoundEffectLabel label)
    {
        se_stop_tasks_.push(label);
    }

    //--------------------------------------------------------------------------------
    //  指定したサウンドが終わってるかをチェック
    //  label : sound effectのラベル
    //--------------------------------------------------------------------------------
    bool IsOver(const SoundEffectLabel label) const;

    //--------------------------------------------------------------------------------
    //  指定したサウンドがなってるかをチェック
    //  label : sound effectのラベル
    //--------------------------------------------------------------------------------
    bool IsPlaying(const SoundEffectLabel label) const;

    //--------------------------------------------------------------------------------
    //  全てのサウンドを止まる
    //--------------------------------------------------------------------------------
    void StopAll(void);

private:
    //--------------------------------------------------------------------------------
    //　構造体定義
    //--------------------------------------------------------------------------------
    struct SoundEffectInfo
    {
        String file_path;
        int    count_loop;
    };

    //--------------------------------------------------------------------------------
    //  constructors and destructors
    //--------------------------------------------------------------------------------
    SoundSystem();
    SoundSystem(const SoundSystem& value) {}
    SoundSystem& operator=(const SoundSystem& value) {}
    ~SoundSystem() {}

    //--------------------------------------------------------------------------------
    //  初期化処理
    //--------------------------------------------------------------------------------
    void Init(void);

    //--------------------------------------------------------------------------------
    //  初期化処理
    //--------------------------------------------------------------------------------
    bool InitXAudio(void);

    //--------------------------------------------------------------------------------
    //  サウンドデータファイルの読込
    //--------------------------------------------------------------------------------
    void LoadSoundEffectData(void);

    //--------------------------------------------------------------------------------
    //  終了処理
    //--------------------------------------------------------------------------------
    void Uninit(void);

    //--------------------------------------------------------------------------------
    //  マルチスレッド処理
    //--------------------------------------------------------------------------------
    void Run(void);

    //--------------------------------------------------------------------------------
    //  SEの鳴らす処理
    //--------------------------------------------------------------------------------
    void PlaySe(void);

    //--------------------------------------------------------------------------------
    //  SEの止める処理
    //--------------------------------------------------------------------------------
    void StopSe(void);

    //--------------------------------------------------------------------------------
    //  チャンクのチェック
    //--------------------------------------------------------------------------------
    bool CheckChunk(HANDLE file, DWORD format, DWORD& chunk_size, DWORD& chunk_data_position);

    //--------------------------------------------------------------------------------
    //  チャンクデータの読み込み
    //--------------------------------------------------------------------------------
    bool ReadChunkData(HANDLE file, void *buffer, DWORD buffer_size, DWORD buffer_offset);

    //--------------------------------------------------------------------------------
    //  変数定義
    //--------------------------------------------------------------------------------
    bool                     is_running_ = true;
    thread*                  thread_ = nullptr;
    IXAudio2*                xaudio2_instance_ = nullptr;
    IXAudio2MasteringVoice*  mastering_voice_ = nullptr;
    IXAudio2SourceVoice*     se_source_voices_[kSoundEffectMax] = { 0 };
    BYTE*                    se_datas_[kSoundEffectMax] = { 0 };
    DWORD                    se_sizes_[kSoundEffectMax] = { 0 };
    queue<SoundEffectLabel>  se_play_tasks_;
    queue<SoundEffectLabel>  se_stop_tasks_;
    static SoundEffectInfo   se_infos_[kSoundEffectMax];
};